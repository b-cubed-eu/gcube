---
  title: "virtualspecies_to_sf()"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Function virtualspecies_to_sf()}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---
  ## Aim
  The function creates a given number of virtual species and returns an **sf** object with the virtual species occurrences as well as its environmental suitability over space: this can be useful to test real data. 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```

```{r, message = FALSE, warning=FALSE}
library(virtualspecies)
library(tidyverse)
library(raster)
```

## Input Data
The required format of input data is a ```RasterStack``` containing all the environmental variables with which you want to generate a virtual species distribution.

WorldClim (www.worldclim.org) freely provides gridded climate data  for the entire world. These data can be downloaded to your hard drive from the website above, and then imported into R using the ```stack``` command.

Otherwise, you can directly download them into R using the functions ```worldclim_global()```, ```worldclim_country()```, ```worldclim_tiles()``` from **geodata** package (requires an internet connection).
```{r }
library(geodata)

# Download all 19 bioclimatic variables within a country and create a stack object 
d <- worldclim_country(country = "Italy", var = "bio", res=0.5, path=tempdir()) %>% stack()

# Let's choose 3 random layers out of 19
random_index <- sample(1:nlayers(d), 3)
covariates_stack <- d[[random_index]]
plot(covariates_stack)
```
```{r }
virtualspecies_to_sf <- function(
  nsp = 10,
  covariates_stack,
  polygon = NA,
  seed = NA){
  
  if(!is.na(polygon)){
    covariates_stack <- covariates_stack %>%
      terra::mask(polygon)
    if(nrow(covariates_stack))
      cli::cli_abort(c(
        "polygon must overlap the covariates_stack",
      ))
  }
  
  random.sp <- generateRandomSp(raster.stack = covariates_stack,
                                convert.to.PA = FALSE,
                                species.type = "multiplicative",
                                relations = "gaussian",
                                realistic.sp = TRUE,
                                plot = FALSE)
  
  new.pres <-convertToPA(random.sp,
                         beta = "random",
                         alpha = -0.05, plot = FALSE,
                         species.prevalence = 0.02)
  
  presence.points <- sampleOccurrences(new.pres,
                                       n = 40,
                                       type = "presence only",
                                       sample.prevalence = 0.5,
                                       detection.probability = 0.8,
                                       correct.by.suitability = TRUE,
                                       plot = TRUE)
  
  sf_occurrences <- presence.points$sample.points %>%
    st_as_sf(coords = c("x", "y"))
  
  suitab_raster <- random.sp$suitab.raster
  
  return(list(sf_occurrences = sf_occurrences, suitab_raster = suitab_raster))
}

```
