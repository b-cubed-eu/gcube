---
title: "4. Creating cubes for multiple species"
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The workflow for simulating a biodiversity data cubes is provided in tutorials 1-3.
However, this workflow only describes a data cube for a single species.
As such, it is not really a cube since it is not three-dimensional.
Furthermore, many biodiversity indicators are calculated over multiple species.

This tutorial describes the functions provided to simulate biodiversity data cubes for multiple species directly.

```{r setup, warning=FALSE, message=FALSE}
# Load packages
library(gcube)

library(sf)        # work with spatial objects
library(dplyr)     # data wrangling
library(ggplot2)   # data visualisation
```

# Spatial extend

As input, we create a polygon in which we simulate occurrences.

```{r}
polygon <- st_polygon(list(cbind(c(500, 1000, 1000, 600, 200, 100, 500),
                                 c(200, 100, 700, 1000, 900, 500, 200))))
```

The polygon looks like this.

```{r}
#| fig.alt: >
#|   Spatial extend in which we will simulate species occurrences.
ggplot() +
  geom_sf(data = polygon) +
  theme_minimal()
```

Also consider a road across our polygon.

```{r}
# Define the road width
road_width <- 50

# Create road points
road_points <- rbind(c(100, 500), c(1000, 500))

# Create road-like polygon within the given polygon
road_polygon <- st_linestring(road_points) %>%
  st_buffer(road_width) %>%
  st_intersection(polygon) %>%
  st_polygon() %>%
  st_sfc() %>%
  st_as_sf() %>%
  rename(geometry = x)
```

The result looks like this.

```{r}
#| fig.alt: >
#|   Spatial extend with road in which we will simulate species occurrences.
ggplot() +
  geom_sf(data = polygon, fill = "lightgreen") +
  geom_sf(data = road_polygon) +
  theme_minimal()
```

# Input dataframe

To generate cubes for multiple species efficiently, we create a dataframe where each row represents a different species and where we specify all arguments to be used by the main cube simulation functions, viz `simulate_occurrences()`, `sample_observations()`, `filter_observations()`, `add_coordinate_uncertainty()`, and `grid_designation()`, in separate columns.
The values within these columns can change between species.

```{r}
multi_species_dataset <- tibble(
  plgn = rep(list(polygon), 6),
  initial_average_abundance = rep(c(50, 100, 500), 2),
  n_time_points = rep(6, 6),
  temporal_function = c(simulate_random_walk, simulate_random_walk, rep(NA, 4)),
  sd_step = c(1, 1, rep(NA, 4)),
  spatial_autocorr = c(rep("random", 3), rep("clustered", 3)),
  detection_probability = rep(c(0.8, 0.9, 1), 2),
  sampling_bias = c(rep("polygon", 3), rep("no_bias", 3)),
  bias_area = c(rep(list(road_polygon), 3), rep(NA, 3)),
  bias_strength = c(c(0.1, 0.2, 0.3), rep(1, 3)),
  coords_uncertainty_meters = rep(c(25, 30, 50), 2),
  grid = rep(list(cube_grid), 6),
  seed = 123
)

glimpse(multi_species_dataset)
```

