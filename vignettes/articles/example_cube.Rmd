---
title: "example_cube"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# load libraries

```{r}
library(gcube)
library(sf)
library(tidyverse)

```

# Create random points

n_points: number of needed virtual occurrences in a grid

define grid bounding box: 
              xlim: bounding box
              ylim: bounding box

add variables here: n_points ; xlim ; ylim

```{r}

n_points <- 10
xlim <- c(3841000, 3842000)
ylim <- c(3110000, 3112000)
coordinate_uncertainty <- rgamma(n_points, shape = 5, rate = 0.1)

```

# create spatial dataframe with occurrences

create random occurrences following *uniform distribution* within the bounding box
define CRS
aggregate TRUE or FALSE

```{r}
observations_sf <- data.frame(
  lat = runif(n_points, ylim[1], ylim[2]),
  long = runif(n_points, xlim[1], xlim[2]),
  aggregate = TRUE,
  coordinateUncertaintyInMeters = coordinate_uncertainty
) %>% st_as_sf(coords = c("long", "lat"), crs = 3035, remove = FALSE)
```

# Visualize points

simple observation of randomized points within bounding box

```{r}
ggplot(data = observations_sf) +
  geom_sf(color = "red")
```

# Add buffer uncertainty in meters around points

add a buffer ('coordinateUncertaintyInMeters') around the observations

```{r}

observations_buffered <- observations_sf %>%
  st_buffer(observations_sf$coordinateUncertaintyInMeters)
```


visualize virtual observations with buffer

```{r}
ggplot(data = observations_buffered) +
  geom_sf(color = "cyan3", fill = "cyan")
```


# Create grid


```{r}
grid_df <- st_make_grid(
  observations_buffered,
  square = TRUE,
  cellsize = c(200, 200)
) %>%
  st_sf()
```

visualize grid

```{r}
ggplot(data = grid_df) +
  geom_sf(color = "darkolivegreen4", fill = "aquamarine")
```



# Grid designation

use the grid designation function to point observations to grid squares

```{r}
occurrence_cube_df <- grid_designation(
  observations = observations_sf,
  grid = grid_df,
  seed = 123)
```

# Visualise Grid designation
```{r}
# ggplot() +
#   geom_sf(data = occurrence_cube_df, linewidth = 1, aes(fill = as.factor(n))) +
#   geom_sf_text(data = occurrence_cube_df, aes(label = n)) +
#  # scale_fill_manual() + 
# # geom_sf(data = grid_df, color = "red", fill = "darkgreen")
#   theme_void()

ggplot() +
  geom_sf(data = occurrence_cube_df, linewidth = 1, aes(fill = as.factor(n))) +
  geom_sf_text(data = occurrence_cube_df, aes(label = n)) +
  scale_fill_manual(values = c("darkolivegreen1", "aquamarine2", "darkolivegreen3","cyan")) + 
  theme_void()

```


# also get sampled points to visualise

```{r}
sampled_points <- grid_designation(
  observations = observations_sf,
  grid = grid_df,
  seed = 123,
  aggregate = FALSE)
```


# visualize output

points are designated to grid, bufer is visible


```{r}
ggplot() +
  geom_sf(data = grid_df, linewidth = 1, color = "aquamarine", fill = "lightgreen") +
  
  geom_sf(data = observations_sf, colour = "lightgreen") +
  geom_sf(data = observations_buffered, fill = alpha("firebrick", 0.5)) +
  theme_void()
```




# Visualise output complete

Complete output. 
Grid with number of designated sampled occurrences to the grid. 


```{r}

ggplot() +
  geom_sf(data = occurrence_cube_df, linewidth = 1, aes(fill = as.factor(n))) +
  geom_sf_text(data = occurrence_cube_df, aes(label = n)) +
  geom_sf(data = sampled_points, colour = "blue") +
  geom_sf(data = observations_sf, colour = "firebrick") +
  geom_sf(data = observations_buffered, fill = alpha("firebrick", 0.5)) +
  scale_fill_manual(values = c("darkolivegreen1", "aquamarine2", "darkolivegreen3","cyan")) + 
  theme_void()

```




