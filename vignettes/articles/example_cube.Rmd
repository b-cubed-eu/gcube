---
title: "example_cube"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# load libraries

```{r}
library(simcuber)
library(dplyr)
library(sf)
library(ggplot2)
library(tidyverse)
library(magrittr)
```

# Create random points

n_points: number of needed virtual occurrences in the grid
xlim: bounding box
ylim: bounding box

Add variables here
```{r}

n_points <- 23
xlim <- c(3841000, 3842000)
ylim <- c(3110000, 3112000)
coordinate_uncertainty <- rgamma(n_points, shape = 5, rate = 0.1)

```

# create spatial dataframe with occurrences

```{r}
observations_sf <- data.frame(
  lat = runif(n_points, ylim[1], ylim[2]),
  long = runif(n_points, xlim[1], xlim[2]),
  aggregate = FALSE,
  coordinateUncertaintyInMeters = coordinate_uncertainty
) %>% st_as_sf(coords = c("long", "lat"), crs = 3035, remove = FALSE)
```


# Add buffer uncertainty in meters around points

```{r}

observations_buffered <- observations_sf %>%
  st_buffer(observations_sf$coordinateUncertaintyInMeters)
```

# Create grid
```{r}
grid_df <- st_make_grid(
  observations_buffered,
  square = TRUE,
  cellsize = c(200, 200)
) %>%
  st_sf()
```

# Create occurrence cube
```{r}
grid <- grid_designation(
  observations = observations_sf,
  grid = grid_df,
  seed = 123
)
```

# Also get sampled points to visualise

```{r}
sampled_points <- grid_designation(
  observations = observations_sf,
  grid = grid_df,
  seed = 123,
  aggregate = FALSE)
```

# Create occurrence cube
```{r}
occurrence_cube_df <- grid_designation(
  observations = observations_sf,
  grid = grid_df,
  seed = 123)
```

# visualize output 1


```{r}
ggplot() +
  geom_sf(data = grid_df, linewidth = 1, color = "red", fill = "lightgreen") +
  geom_sf(data = observations_sf, colour = "firebrick") +
  geom_sf(data = observations_buffered, fill = alpha("firebrick", 0.5)) +
  theme_void()
```




# Visualise output complete
```{r}
ggplot() +
  geom_sf(data = occurrence_cube_df, linewidth = 1) +
  geom_sf_text(data = occurrence_cube_df, aes(label = n)) +
  geom_sf(data = sampled_points, colour = "blue") +
  geom_sf(data = observations_sf, colour = "firebrick") +
  geom_sf(data = observations_buffered, fill = alpha("firebrick", 0.5)) +
 # geom_sf(data = grid_df, color = "red", fill = "darkgreen")
  theme_void()

```
# Visualise output grid
```{r}
ggplot() +
  geom_sf(data = occurrence_cube_df, linewidth = 1) +
  geom_sf_text(data = occurrence_cube_df, aes(label = n)) +
# geom_sf(data = grid_df, color = "red", fill = "darkgreen")
  theme_void()

```





visualize grid

```{r}
ggplot(data = grid) +
  geom_sf(color = "red", fill = "darkgreen")
```
Visualize points
```{r}
ggplot(data = observations_sf) +
  geom_sf(color = "red", fill = "darkgreen")
```
Visualize bufer
```{r}
ggplot(data = observations_buffered) +
  geom_sf(color = "red", fill = "darkgreen")
```
