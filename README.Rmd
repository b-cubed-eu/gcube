---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = file.path("man", "figures", "README-"),
  out.width = "100%"
)
```

# gcube <a href="https://b-cubed-eu.github.io/gcube/"><img src="man/figures/logo.png" alt="gcube website" align="right" height="120"/></a>

<!-- badges: start -->

[![CRAN status](https://www.r-pkg.org/badges/version/gcube)](https://CRAN.R-project.org/package=gcube) [![R-CMD-check](https://github.com/b-cubed-eu/gcube/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/b-cubed-eu/gcube/actions/workflows/R-CMD-check.yaml) [![codecov](https://codecov.io/gh/b-cubed-eu/gcube/branch/main/graph/badge.svg)](https://app.codecov.io/gh/b-cubed-eu/gcube/) [![repo status](https://www.repostatus.org/badges/latest/concept.svg)](https://www.repostatus.org/#concept)

<!-- badges: end -->

The goal of **gcube** is to provide a simulation framework for biodiversity data cubes using the R programming language. This can start from simulating multiple species distributed in a landscape over a temporal scope. In a second phase, the simulation of a variety of observation processes and effort can generate actual occurrence datasets. Based on their (simulated) spatial uncertainty, occurrences can then be designated to a grid to form a data cube.

Simulation studies offer numerous benefits due to their ability to mimic real-world scenarios in controlled and customizable environments. Ecosystems and biodiversity data are very complex and involve a multitude of interacting factors. Simulations allow researchers to model and understand the complexity of ecological systems by varying parameters such as spatial and/or temporal clustering, species prevalence, etc.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("b-cubed-eu/gcube")
```

## Example

This is a basic example which shows you the workflow for simulating a biodiversity data cube.
This is divided in three steps or processes:

1.  Occurrence process
2.  Detection process
3.  Grid designation process

The functions are set up such that a single polygon as input is enough to go through this workflow using default arguments.
The user can change these arguments to allow for more flexibility.


```{r example}
# Load packages
library(gcube)   # loads dplyr and sf dependencies as well
library(ggplot2) # visualisation with ggplot
```

We create a random polygon as input.

```{r example}
# Create a polygon to simulate occurrences
polygon <- st_polygon(list(cbind(c(5,10,8,2,3,5), c(2,1,7,9,5,2))))

# Visualise
ggplot() + 
  geom_sf(data = polygon) +
  theme_minimal()
```

### Occurrence process

We generate occurrence points within the polygon using the `simulate_occurrences()` function.
These are the "real" occurrences of the species, whether we have observed them or not. 
In the `simulate_occurrences()` function, the user can specify different levels of spatial clustering, and can define the trend change of the species over time.

```{r simulate-occurrences}
# Simulate occurrences within polygon
occurrences_df <- simulate_occurrences(
  plgn = polygon,
  seed = 123)

# Visualise
ggplot() + 
  geom_sf(data = polygon) +
  geom_sf(data = occurrences_df) +
  theme_minimal()
```

### Detection process

In this step we define the sampling process, based on the detection probability of the species and the sampling bias.
This is done using the `sample_observations()` function.
The default sampling bias is `"no_bias"`, but bias can also be inserted using a polygon or a grid.

```{r}
# Detect occurrences
detections_df_raw <- sample_observations(
  occurrences = occurrences_df,
  detection_probability = 0.5,
  seed = 123)

# Visualise
ggplot() + 
  geom_sf(data = polygon) +
  geom_sf(data = detections_df_raw,
          aes(colour = sampling_status)) +
  theme_minimal()
```

We select the detected occurrences and add an uncertainty to these observations.
This can be done using the `add_coordinate_uncertainty()` function.

```{r}
# Select detected occurrences only
detections_df <- detections_df_raw %>%
  dplyr::filter(sampling_status == "detected")

# Add coordinate uncertainty
observations_df <- add_coordinate_uncertainty(
  observations = detections_df,
  coords_uncertainty_meters = 0.3)

# Visualise
ggplot() + 
  geom_sf(data = polygon) +
  geom_sf(data = st_buffer(observations_df,
                           observations_df$coordinateUncertaintyInMeters),
          fill = alpha("firebrick", 0.3)) +
  geom_sf(data = observations_df) +
  theme_minimal()
```

### Grid designation process

Finally, occurrences are designated to a grid to create a occurrence cube.

```{r grid-designation}
# Define your grid
grid_df <- st_make_grid(
  belgium, # grid as the extent of polygon
  n = c(10,10)) %>% 
  st_intersection(belgium) %>% 
  st_as_sf() %>% 
  rename(geometry = x)


gridded_obs <- grid_designation(
  observations = obs,
  grid = grid_df)

ggplot() + 
  geom_sf(data = belgium,
          fill = "grey80",
          col = "black") +
  geom_sf(data = gridded_obs, aes(fill = n)) +
  scale_fill_continuous("Number of\nobservations", type = "viridis") +
  theme_minimal()

```
