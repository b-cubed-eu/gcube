---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = file.path("man", "figures", "README-"),
  out.width = "100%"
)
```

# gcube <a href="https://b-cubed-eu.github.io/gcube/"><img src="man/figures/logo.png" alt="gcube website" align="right" height="120"/></a>

<!-- badges: start -->

[![CRAN status](https://www.r-pkg.org/badges/version/gcube)](https://CRAN.R-project.org/package=gcube) [![R-CMD-check](https://github.com/b-cubed-eu/gcube/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/b-cubed-eu/gcube/actions/workflows/R-CMD-check.yaml) [![codecov](https://codecov.io/gh/b-cubed-eu/gcube/branch/main/graph/badge.svg)](https://app.codecov.io/gh/b-cubed-eu/gcube/) [![repo status](https://www.repostatus.org/badges/latest/concept.svg)](https://www.repostatus.org/#concept)

<!-- badges: end -->

The goal of **gcube** is to provide a simulation framework for biodiversity data cubes using the R programming language. This can start from simulating multiple species distributed in a landscape over a temporal scope. In a second phase, the simulation of a variety of observation processes and effort can generate actual occurrence datasets. Based on their (simulated) spatial uncertainty, occurrences can then be designated to a grid to form a data cube.

Simulation studies offer numerous benefits due to their ability to mimic real-world scenarios in controlled and customizable environments. Ecosystems and biodiversity data are very complex and involve a multitude of interacting factors. Simulations allow researchers to model and understand the complexity of ecological systems by varying parameters such as spatial and/or temporal clustering, species prevalence, etc.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("b-cubed-eu/gcube")
```

## Example

This is a basic example which shows you how to solve a common problem:

```{r example}
library(gcube)
library(tidyverse)
library(rnaturalearthdata)
library(rnaturalearth)
library(terra)
library(sf)
library(patchwork)

# Get a polygon to add points to
belgium <- ne_countries(scale = "medium", country = "Belgium",
                        returnclass = "sf") %>% 
  dplyr::select(1) 

ggplot() + 
  geom_sf(data = belgium, 
          fill = "grey80",
          col = "black") +
  theme_minimal()
```

## Occurrence process
We generate occurrence points within the polygon of interest, these are the "real" occurrences of the species, whether we have observed them or not. 
In the `r simulate_occurrences()` function the user can specify different levels of spatial clustering, and can define the trend change of the species over time.

```{r simulate occurrences}
# occ <- simulate_occurrences(polygon_sf)
occ <- st_sample(belgium, 50) %>% st_as_sf() %>% 
  rename(geometry = x) %>% 
  mutate(time_point = 1)

ggplot() + 
  geom_sf(data = belgium, 
          fill = "grey80",
          col = "black") +
  geom_sf(data = occ) +
  theme_minimal()
```

## Detection process
In this step we define the sampling process, based on the detection probability of the species and the sampling effort. 
```{r}
obs <- sample_observations(
  occ,
  detection_probability = 0.5,
  sampling_bias = "no_bias"
)
# sampled_occ <- sample_n(occ, 25)

ggplot() + 
  geom_sf(data = belgium, 
          fill = "grey80",
          col = "black") +
  geom_sf(data = occ) +
  geom_sf(data = obs, col = "darkorange") +
  ggtitle("Detected occurrences in orange") +
  theme_minimal()
```

## Grid designation process
Finally, occurrences are designated to a grid to create a occurrence cube.
```{r grid designation}
sf_use_s2(FALSE)
# Add buffer uncertainty in meters around points, randomly sampled from gamma distribution
buffered_obs <- add_coordinate_uncertainty(
  obs,
  coords_uncertainty_meters = 10)

# Define your grid
grid_df <- st_make_grid(
  belgium, # grid as the extent of polygon
  n = c(10,10)) %>% 
  st_intersection(belgium) %>% 
  st_as_sf() %>% 
  rename(geometry = x)
plot(grid_df)  

gridded_obs <- grid_designation(
  observations = obs,
  grid = grid_df)

ggplot() + 
  geom_sf(data = belgium,
          fill = "grey80",
          col = "black") +
  geom_sf(data = occ) +
  geom_sf(data = obs, col = "darkorange") +
  geom_sf(data = gridded_obs, aes(fill = n)) +
  scale_fill_continuous("Number of\nobservations", type = "viridis") +
  theme_minimal()

```


